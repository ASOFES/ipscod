{% extends 'base.html' %}
{% load static %}
{% block title %}Rapport d'évaluation des chauffeurs{% endblock %}
<!-- Conteneur pour les toasts -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div class="toast-container"></div>
</div>

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-user-tie me-2"></i>Rapport d'évaluation des chauffeurs</h1>
        <div>
            <a href="{% url 'rapport:evaluation_chauffeurs_advanced' %}" class="btn btn-outline-primary">
                <i class="fas fa-chart-line me-1"></i>Vue avancée
            </a>
        </div>
    </div>
    
    <form method="get" class="row g-3 mb-3">
        <div class="col-md-3">
            <label for="chauffeur" class="form-label">Chauffeur</label>
            <select name="chauffeur" id="chauffeur" class="form-select">
                <option value="">Tous</option>
                {% for c in chauffeurs %}
                <option value="{{ c.id }}" {% if selected_chauffeur == c.id|stringformat:'s' %}selected{% endif %}>{{ c.get_full_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="date_debut" class="form-label">Date début</label>
            <input type="date" name="date_debut" id="date_debut" class="form-control" value="{{ date_debut }}">
        </div>
        <div class="col-md-3">
            <label for="date_fin" class="form-label">Date fin</label>
            <input type="date" name="date_fin" id="date_fin" class="form-control" value="{{ date_fin }}">
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100"><i class="fas fa-filter me-1"></i>Filtrer</button>
        </div>
    </form>
    <div class="mb-3 d-flex justify-content-end gap-2">
        <a href="?{% for k,v in request.GET.items %}{% if k != 'export' %}{{k}}={{v|urlencode}}&{% endif %}{% endfor %}export=pdf" class="btn btn-outline-danger"><i class="fas fa-file-pdf me-1"></i>Exporter PDF</a>
        <a href="?{% for k,v in request.GET.items %}{% if k != 'export' %}{{k}}={{v|urlencode}}&{% endif %}{% endfor %}export=excel" class="btn btn-outline-success"><i class="fas fa-file-excel me-1"></i>Exporter Excel</a>
    </div>

    <!-- Moyennes de l'établissement -->
    {% if moyennes %}
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="card-title mb-0"><i class="fas fa-chart-line me-2"></i>Moyennes de l'établissement</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-2">
                    <div class="border rounded p-3 text-center">
                        <h6 class="text-muted mb-2">Score moyen</h6>
                        <h4 class="text-primary">{% if moyennes.score_moyen %}{{ moyennes.score_moyen }}/100{% else %}-{% endif %}</h4>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="border rounded p-3 text-center">
                        <h6 class="text-muted mb-2">Missions par jour</h6>
                        <h4>{% if moyennes.missions_par_jour %}{{ moyennes.missions_par_jour|floatformat:2 }}{% else %}-{% endif %}</h4>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="border rounded p-3 text-center">
                        <h6 class="text-muted mb-2">Distance moyenne</h6>
                        <h4>{% if moyennes.distance_moyenne %}{{ moyennes.distance_moyenne|floatformat:2 }} km{% else %}-{% endif %}</h4>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="border rounded p-3 text-center">
                        <h6 class="text-muted mb-2">Consommation moyenne</h6>
                        <h4>{% if moyennes.conso_moyenne %}{{ moyennes.conso_moyenne|floatformat:2 }} L/100km{% else %}-{% endif %}</h4>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="border rounded p-3 text-center">
                        <h6 class="text-muted mb-2">Coût moyen/km</h6>
                        <h4>{% if moyennes.cout_km %}{{ moyennes.cout_km|floatformat:2 }} $/km{% else %}-{% endif %}</h4>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="border rounded p-3 text-center">
                        <h6 class="text-muted mb-2">Chauffeurs évalués</h6>
                        <h4 class="text-info">{{ moyennes.total_chauffeurs }}</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Chauffeur</th>
                    <th>Score</th>
                    <th>Classification</th>
                    <th>Total missions</th>
                    <th>Missions terminées</th>
                    <th>Jours prestés</th>
                    <th>Distance totale (km)</th>
                    <th>Ancienneté (jours)</th>
                    <th>Distance moyenne (km)</th>
                    <th>Missions/jour</th>
                    <th>Consommation (L/100km)</th>
                    <th>Coût/km ($/km)</th>
                    <th>Top destinations</th>
                    <th>Recommandations</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody>
                {% for eval in evaluations %}
                <tr>
                    <td>
                        <strong>{{ eval.chauffeur.get_full_name }}</strong>
                        <br><small class="text-muted">{{ eval.vehicule.immatriculation }}</small>
                    </td>
                    <td>
                        <div class="text-center">
                            <h5 class="mb-1">{{ eval.score_total }}/100</h5>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar {% if eval.score_total >= 85 %}bg-success{% elif eval.score_total >= 70 %}bg-primary{% elif eval.score_total >= 55 %}bg-warning{% elif eval.score_total >= 40 %}bg-danger{% else %}bg-dark{% endif %}" 
                                     style="width: {{ eval.score_total }}%"></div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge {{ eval.badge_class }} fs-6">{{ eval.classification }}</span>
                    </td>
                    <td>{% if eval.nb_courses %}{{ eval.nb_courses }}{% else %}-{% endif %}</td>
                    <td>{% if eval.nb_courses_terminees %}{{ eval.nb_courses_terminees }}{% else %}-{% endif %}</td>
                    <td>{% if eval.nb_jours_prestes %}{{ eval.nb_jours_prestes }}{% else %}-{% endif %}</td>
                    <td>{% if eval.distance_totale %}{{ eval.distance_totale|floatformat:2 }} km{% else %}-{% endif %}</td>
                    <td>{% if eval.anciennete %}{{ eval.anciennete }} j{% else %}-{% endif %}</td>
                    <td>{% if eval.distance_moyenne %}{{ eval.distance_moyenne|floatformat:2 }} km{% else %}-{% endif %}</td>
                    <td>{% if eval.missions_par_jour %}{{ eval.missions_par_jour|floatformat:2 }}{% else %}-{% endif %}</td>
                    <td>{% if eval.conso_moyenne %}{{ eval.conso_moyenne|floatformat:2 }} L/100km{% else %}-{% endif %}</td>
                    <td>{% if eval.cout_km %}{{ eval.cout_km|floatformat:2 }} $/km{% else %}-{% endif %}</td>
                    <td>
                        {% if eval.top_destinations %}
                        <ul class="list-unstyled mb-0">
                            {% for dest in eval.top_destinations %}
                            <li><small>{{ dest }}</small></li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>
                        {% if eval.recommandations %}
                        <ul class="list-unstyled mb-0">
                            {% for rec in eval.recommandations %}
                            <li><small class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>{{ rec }}</small></li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <small class="text-success"><i class="fas fa-check-circle me-1"></i>Aucune recommandation</small>
                        {% endif %}
                    </td>
                    <td>
                        <form method="post" class="notes-form" data-chauffeur-id="{{ eval.chauffeur.id }}">
                            {% csrf_token %}
                            <input type="hidden" name="chauffeur_id" value="{{ eval.chauffeur.id }}">
                            <div class="input-group">
                                <input type="text" class="form-control form-control-sm" name="notes" 
                                       value="{{ eval.notes|default:'' }}" placeholder="Ajouter des notes...">
                                <button type="submit" name="save_notes" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-save"></i>
                                </button>
                            </div>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="15" class="text-center">Aucune donnée disponible.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Détails du scoring -->
    <div class="card mt-4">
        <div class="card-header bg-info text-white">
            <h5 class="card-title mb-0"><i class="fas fa-info-circle me-2"></i>Détails du système de scoring</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <h6 class="text-primary">Productivité (40%)</h6>
                    <p class="small">Basé sur le nombre de missions par jour. Objectif : 2 missions/jour = 100%</p>
                </div>
                <div class="col-md-3">
                    <h6 class="text-success">Efficacité énergétique (25%)</h6>
                    <p class="small">Basé sur la consommation moyenne. Objectif : ≤6L/100km = 100%</p>
                </div>
                <div class="col-md-3">
                    <h6 class="text-warning">Rentabilité (20%)</h6>
                    <p class="small">Basé sur le coût par km. Objectif : ≤50$/km = 100%</p>
                </div>
                <div class="col-md-3">
                    <h6 class="text-info">Régularité (15%)</h6>
                    <p class="small">Basé sur l'assiduité. Objectif : 30 jours/mois = 100%</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} 
{% block extra_js %}
<script>
$(document).ready(function() {
    $('.notes-form').on('submit', function(e) {
        e.preventDefault();
        var form = $(this);
        
        $.ajax({
            type: 'POST',
            url: window.location.pathname,
            data: form.serialize(),
            success: function(response) {
                // Afficher un message de succès
                var toast = $('<div class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true"><div class="d-flex"><div class="toast-body">Notes enregistrées avec succès</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div></div>');
                
                $('.toast-container').html(toast);
                var toastEl = new bootstrap.Toast(toast[0]);
                toastEl.show();
                
                // Cacher le toast après 3 secondes
                setTimeout(function() {
                    toastEl.hide();
                }, 3000);
            },
            error: function() {
                alert('Une erreur est survenue lors de l\'enregistrement des notes.');
            }
        });
    });
});
</script>
{% endblock %}
