{% extends "base.html" %}
{% load static %}

{% block title %}Rapport Avancé - {{ rapport.vehicule.marque }} {{ rapport.vehicule.modele }}{% endblock %}

{% block extra_css %}
<style>
    .card {
        margin-bottom: 20px;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    .card-header {
        font-weight: 600;
    }
    .stat-card {
        text-align: center;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 5px;
        background-color: #f8f9fa;
    }
    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #2c3e50;
    }
    .stat-label {
        font-size: 14px;
        color: #7f8c8d;
    }
    .table th {
        background-color: #f8f9fa;
    }
    .alert-icon {
        font-size: 24px;
        margin-right: 10px;
    }
    .export-buttons {
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-tête du rapport -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-car me-2"></i> Rapport Avancé - {{ rapport.vehicule.marque }} {{ rapport.vehicule.modele }}
                        <small class="d-block mt-1">Immatriculation: {{ rapport.vehicule.immatriculation }} | Année: {{ rapport.vehicule.annee }}</small>
                    </h4>
                    <div class="btn-group">
                        <a href="?export=pdf" class="btn btn-sm btn-light">
                            <i class="fas fa-file-pdf me-1"></i> Exporter en PDF
                        </a>
                        <a href="?export=excel" class="btn btn-sm btn-light ms-2">
                            <i class="fas fa-file-excel me-1"></i> Exporter en Excel
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Type de véhicule :</strong> {{ rapport.vehicule.type_vehicule }}</p>
                            <p><strong>Carburant :</strong> {{ rapport.vehicule.carburant }}</p>
                            <p><strong>Date de mise en circulation :</strong> {{ rapport.vehicule.date_mise_en_circulation }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Statut :</strong> 
                                <span class="badge bg-{{ rapport.vehicule.statut|lower == 'en service'|lower ? 'success' : 'warning' }}">
                                    {{ rapport.vehicule.statut }}
                                </span>
                            </p>
                            <p><strong>Kilométrage actuel :</strong> {{ rapport.vehicule.kilometrage_actuel|floatformat:0 }} km</p>
                            <p><strong>Consommation moyenne :</strong> {{ rapport.vehicule.consommation_moyenne|default:"-" }} L/100km</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alertes -->
    {% if rapport.alertes %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i> Alertes</h5>
                </div>
                <div class="card-body">
                    {% for alerte in rapport.alertes %}
                    <div class="alert alert-{{ alerte.niveau|lower == 'alerte' ? 'danger' : alerte.niveau|lower == 'attention' ? 'warning' : 'info' }} d-flex align-items-center">
                        <i class="fas fa-{{ alerte.type == 'entretien' ? 'tools' : alerte.type == 'securite' ? 'shield-alt' : 'chart-line' }} me-2"></i>
                        <div>
                            <strong>{{ alerte.niveau }} :</strong> {{ alerte.message }}
                            <div class="small text-muted">{{ alerte.date_alerte }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i> Statistiques</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 col-6">
                            <div class="stat-card">
                                <div class="stat-value text-primary">{{ rapport.statistiques.distance_totale|floatformat:0 }} <small>km</small></div>
                                <div class="stat-label">Distance totale</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="stat-card">
                                <div class="stat-value text-success">{{ rapport.statistiques.missions_count }}</div>
                                <div class="stat-label">Missions effectuées</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="stat-card">
                                <div class="stat-value text-info">{{ rapport.vehicule.consommation_moyenne|default:"-" }} <small>L/100km</small></div>
                                <div class="stat-label">Consommation moyenne</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="stat-card">
                                <div class="stat-value text-danger">{{ rapport.statistiques.cout_total|floatformat:2 }} <small>€</small></div>
                                <div class="stat-label">Coût total</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Derniers entretiens -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-tools me-2"></i> Derniers entretiens</h5>
                    <a href="#" class="btn btn-sm btn-light">
                        <i class="fas fa-plus me-1"></i> Ajouter
                    </a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Kilométrage</th>
                                    <th>Coût</th>
                                    <th>Prestataire</th>
                                    <th>Observations</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entretien in rapport.entretiens %}
                                <tr>
                                    <td>{{ entretien.date_entretien|date:"d/m/Y" }}</td>
                                    <td>{{ entretien.type_entretien }}</td>
                                    <td>{{ entretien.kilometrage|floatformat:0 }} km</td>
                                    <td>{{ entretien.cout|floatformat:2 }} €</td>
                                    <td>{{ entretien.prestataire|truncatechars:20 }}</td>
                                    <td>{{ entretien.observations|truncatechars:30 }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center py-4">Aucun entretien enregistré</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer text-end">
                    <a href="#" class="btn btn-sm btn-outline-primary">
                        Voir tout l'historique <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Derniers ravitaillements -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-gas-pump me-2"></i> Derniers ravitaillements</h5>
                    <a href="#" class="btn btn-sm btn-light">
                        <i class="fas fa-plus me-1"></i> Ajouter
                    </a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Station</th>
                                    <th>Litres</th>
                                    <th>Prix/L</th>
                                    <th>Coût total</th>
                                    <th>Kilométrage</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ravitaillement in rapport.ravitaillements %}
                                <tr>
                                    <td>{{ ravitaillement.date_ravitaillement|date:"d/m/Y" }}</td>
                                    <td>{{ ravitaillement.station }}</td>
                                    <td>{{ ravitaillement.litres|floatformat:2 }} L</td>
                                    <td>{{ ravitaillement.cout_unitaire|floatformat:3 }} €</td>
                                    <td>{{ ravitaillement.cout_total|floatformat:2 }} €</td>
                                    <td>{{ ravitaillement.kilometrage_apres|floatformat:0 }} km</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center py-4">Aucun ravitaillement enregistré</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer text-end">
                    <a href="#" class="btn btn-sm btn-outline-primary">
                        Voir tout l'historique <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Dernières missions -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-route me-2"></i> Dernières missions</h5>
                    <a href="#" class="btn btn-sm btn-light">
                        <i class="fas fa-plus me-1"></i> Ajouter
                    </a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Chauffeur</th>
                                    <th>Trajet</th>
                                    <th>Distance</th>
                                    <th>Durée</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for mission in rapport.missions %}
                                <tr>
                                    <td>{{ mission.date_mission|date:"d/m/Y" }}</td>
                                    <td>{{ mission.chauffeur }}</td>
                                    <td>{{ mission.lieu_depart }} → {{ mission.lieu_arrivee }}</td>
                                    <td>{{ mission.distance_parcourue }} km</td>
                                    <td>{{ mission.duree }}</td>
                                    <td>
                                        <span class="badge bg-{{ mission.statut|lower == 'terminée' ? 'success' : mission.statut|lower == 'en cours' ? 'warning' : 'secondary' }}">
                                            {{ mission.statut }}
                                        </span>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center py-4">Aucune mission enregistrée</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer text-end">
                    <a href="#" class="btn btn-sm btn-outline-primary">
                        Voir tout l'historique <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Scripts pour les interactions dynamiques
    document.addEventListener('DOMContentLoaded', function() {
        // Initialiser les tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Autres scripts si nécessaire
    });
</script>
{% endblock %}
