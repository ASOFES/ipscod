{% load static %}
{% load core_filters %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Gestion de V√©hicules{% endblock %}</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <!-- Custom CSS -->
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
                    --ips-co-orange: #f39c12;
        --ips-co-red: #e74c3c;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: var(--dark-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .navbar {
            background-color: var(--primary-color);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-brand {
            font-weight: bold;
            color: white !important;
        }
        
        .nav-link {
            color: rgba(255, 255, 255, 0.8) !important;
            transition: color 0.3s, transform 0.2s;
            padding: 0.5rem 1rem;
            border-radius: 4px;
        }
        
        .nav-link:hover {
            color: white !important;
            transform: translateY(-2px);
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .nav-link.active {
            color: white !important;
            font-weight: bold;
            background-color: rgba(255, 255, 255, 0.15);
        }
        
        .dropdown-menu {
            border: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        
        .dropdown-item {
            padding: 0.7rem 1.2rem;
            transition: all 0.2s;
        }
        
        .dropdown-item:hover {
            background-color: var(--light-color);
            transform: translateX(5px);
        }
        
        .dropdown-item.active {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            box-shadow: 0 2px 5px rgba(52, 152, 219, 0.3);
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.4);
        }
        
        .btn-outline-primary {
            border-color: var(--secondary-color);
            color: var(--secondary-color);
            transition: all 0.3s;
        }
        
        .btn-outline-primary:hover {
            background-color: var(--secondary-color);
            color: white;
            transform: translateY(-2px);
        }
        
        .card {
            border-radius: 12px;
            border: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 12px 12px 0 0 !important;
            border-bottom: none;
            padding: 1rem 1.5rem;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .footer {
            background-color: var(--primary-color);
            color: white;
            padding: 30px 0 20px;
            margin-top: auto;
        }
        
        .footer a {
            transition: all 0.2s;
        }
        
        .footer a:hover {
            transform: translateX(3px);
            opacity: 1 !important;
        }
        
        /* Module specific colors */
        .module-securite {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }
        
        .module-demandeur {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }
        
        .module-dispatch {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .module-chauffeur {
            background: linear-gradient(135deg, #f39c12, #d35400);
        }
        
        .module-entretien {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }
        
        .module-ravitaillement {
            background: linear-gradient(135deg, #1abc9c, #16a085);
        }
        
        .module-suivi {
            background: linear-gradient(135deg, #f1c40f, #f39c12);
        }
        
        .module-rapport {
            background: linear-gradient(135deg, #34495e, #2c3e50);
        }
        
        /* Floating action button */
        .floating-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--ips-co-orange), var(--ips-co-red));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transition: all 0.3s;
            border: none;
        }
        
        .floating-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .floating-btn i {
            font-size: 24px;
        }
        
        /* Animations */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .card {
                margin-bottom: 20px;
            }
            
            .floating-btn {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
            }
        }
        
        @keyframes pulse {
            from { box-shadow: 0 0 6px #fff, 0 0 0 #e74c3c; }
            to { box-shadow: 0 0 6px #fff, 0 0 12px #e74c3c; }
        }
        
        #open-chat-btn {
            z-index: 99999 !important;
            pointer-events: auto !important;
            position: fixed !important;
            bottom: 100px;
            right: 100px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f39c12, #e74c3c);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: none;
        }
        
        #open-chat-btn i {
            font-size: 24px;
        }
        
        #open-chat-btn:after {
            content: '';
            position: absolute;
            top: -10px; left: -10px; right: -10px; bottom: -10px;
            pointer-events: none;
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="{% url 'home' %}">
                <img src="{% static 'images/logo_ips_co.png' %}" alt="Logo IPS-CO SARL" height="40" class="me-2">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    {% if user.is_authenticated %}
                        <li class="nav-item">
                            <a class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}" href="{% url 'home' %}">
                                <i class="fas fa-home"></i> Accueil
                            </a>
                        </li>
                        <!-- Menu D√©partements -->
                        <li class="nav-item">
                            <a class="nav-link {% if 'departement' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'departement_list' %}">
                                <i class="fas fa-building"></i> D√©partements
                            </a>
                        </li>
                        <!-- Menu V√©hicules -->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle {% if 'vehicule' in request.resolver_match.url_name %}active{% endif %}" href="#" id="vehiculesDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-car"></i> V√©hicules
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="vehiculesDropdown">
                                <li><a class="dropdown-item" href="{% url 'vehicule_list' %}">Liste des v√©hicules</a></li>
                                {% if user.role|in_list:'admin,dispatch' %}
                                <li><a class="dropdown-item" href="{% url 'vehicule_create' %}">Ajouter un v√©hicule</a></li>
                                {% endif %}
                            </ul>
                        </li>
                        
                        {% if user.role == 'admin' %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle {% if 'user' in request.path %}active{% endif %}" href="#" id="usersDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-users me-1"></i> Utilisateurs
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="usersDropdown">
                                <li><a class="dropdown-item" href="{% url 'user_list' %}"><i class="fas fa-list me-2"></i>Liste des utilisateurs</a></li>
                                <li><a class="dropdown-item" href="{% url 'user_create' %}"><i class="fas fa-user-plus me-2"></i>Ajouter un utilisateur</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="{% url 'application_control_password' %}"><i class="fas fa-lock me-2"></i>Contr√¥le de l'application</a></li>
                            </ul>
                        </li>
                        {% endif %}
                        
                        <!-- Nouveau menu d√©roulant pour les op√©rations -->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle {% if 'demandeur' in request.path or 'dispatch' in request.path or 'chauffeur' in request.path or 'securite' in request.path %}active{% endif %}" href="#" id="operationsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-cogs me-1"></i> Op√©rations
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="operationsDropdown">
                                {% if user.is_authenticated and user.role == 'securite' %}
                                    <li><a class="dropdown-item" href="{% url 'securite:dashboard' %}">S√©curit√©</a></li>
                                {% elif user.is_authenticated and user.role == 'demandeur' %}
                                    <li><a class="dropdown-item" href="{% url 'demandeur:dashboard' %}">Demandes</a></li>
                                {% else %}
                                    <li><a class="dropdown-item {% if 'demandeur' in request.path %}active{% endif %}" href="{% url 'demandeur:dashboard' %}"><i class="fas fa-clipboard-list me-2"></i>Demandes</a></li>
                                    <li><a class="dropdown-item {% if 'dispatch' in request.path %}active{% endif %}" href="{% url 'dispatch:dashboard' %}"><i class="fas fa-tasks me-2"></i>Dispatch</a></li>
                                    <li><a class="dropdown-item {% if 'chauffeur' in request.path %}active{% endif %}" href="{% url 'chauffeur:dashboard' %}"><i class="fas fa-car-side me-2"></i>Chauffeur</a></li>
                                    <li><a class="dropdown-item {% if 'securite' in request.path %}active{% endif %}" href="{% url 'securite:dashboard' %}"><i class="fas fa-shield-alt me-2"></i>S√©curit√©</a></li>
                                    {% if user.role == 'admin' or user.role == 'dispatch' %}
                                    <li><a class="dropdown-item {% if 'entretien' in request.path %}active{% endif %}" href="{% url 'entretien:dashboard' %}"><i class="fas fa-tools me-2"></i>Maintenance</a></li>
                                    {% endif %}
                                    <li><a class="dropdown-item {% if 'ravitaillement' in request.path %}active{% endif %}" href="{% url 'ravitaillement:dashboard' %}"><i class="fas fa-gas-pump me-2"></i>Ravitaillement</a></li>
                                    <li><a class="dropdown-item">TEST-MENU</a></li>
                                {% endif %}
                            </ul>
                        </li>
                        
                        <!-- Menu d√©roulant Rapports -->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="rapportDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-chart-bar me-1"></i> Rapports
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="rapportDropdown">
                                <li><a class="dropdown-item" href="{% url 'rapport:dashboard' %}"><i class="fas fa-list me-2"></i>Accueil des rapports</a></li>
                                <li><a class="dropdown-item" href="{% url 'rapport:missions' %}"><i class="fas fa-clipboard-list me-2"></i>Missions</a></li>
                                <li><a class="dropdown-item" href="{% url 'rapport:entretiens' %}"><i class="fas fa-tools me-2"></i>Entretiens</a></li>
                                <li><a class="dropdown-item" href="{% url 'rapport:carburant' %}"><i class="fas fa-gas-pump me-2"></i>Carburant</a></li>
                                <li><a class="dropdown-item" href="{% url 'rapport:vehicules' %}"><i class="fas fa-car me-2"></i>V√©hicules</a></li>
                                <li><a class="dropdown-item" href="{% url 'rapport:evaluation_chauffeurs' %}"><i class="fas fa-user-tie me-2"></i>Chauffeurs</a></li>
                                <li><a class="dropdown-item" href="{% url 'rapport:depenses_carburant_entretien' %}"><i class="fas fa-dollar-sign me-2"></i>D√©penses</a></li>
                                {% if user.role == 'demandeur' or user.role == 'admin' or user.is_superuser %}
                                <li><a class="dropdown-item" href="{% url 'chauffeur:rapport_demandeur' %}"><i class="fas fa-user me-2"></i>Mon rapport demandeur</a></li>
                                {% endif %}
                                {% if user.role == 'chauffeur' or user.role == 'admin' or user.is_superuser %}
                                <li><a class="dropdown-item" href="{% url 'chauffeur:rapport_chauffeur' %}"><i class="fas fa-user-tie me-2"></i>Mon rapport chauffeur</a></li>
                                {% endif %}
                                {% if user.role == 'admin' %}
                                <li><a class="dropdown-item" href="{% url 'securite:historique_corrections_km' %}"><i class="fas fa-history me-2"></i>Corrections kilom√©trage</a></li>
                                {% endif %}
                                {% if user.role == 'admin' or user.is_superuser %}
                                <li><a class="dropdown-item" href="{% url 'chauffeur:rapport_missions_par_demandeur' %}"><i class="fas fa-users me-2"></i>Missions par demandeur</a></li>
                                {% endif %}
                            </ul>
                        </li>
                    {% endif %}
                </ul>
                
                <ul class="navbar-nav">
                    {% if user.is_authenticated %}
                        <!-- Lien vers les notifications avec badge -->
                        <li class="nav-item">
                            <a class="nav-link position-relative" href="{% url 'notifications:status' %}">
                                <i class="fas fa-bell"></i>
                                <span id="notification-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">
                                    <span id="notification-count">0</span>
                                    <span class="visually-hidden">notifications non lues</span>
                                </span>
                            </a>
                        </li>
                        <!-- Bouton Configuration -->
                        {# <a class="nav-link fw-bold text-warning" href="{% url 'configuration' %}"> #}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                {% if user.photo %}
                                <img src="{{ user.photo.url }}" alt="{{ user.username }}" class="rounded-circle me-1" style="width: 24px; height: 24px; object-fit: cover;">
                                {% else %}
                                <i class="fas fa-user-circle me-1"></i>
                                {% endif %}
                                {{ user.username }}
                                {% if temps_restant is not None %}
                                <span class="badge bg-warning text-dark ms-2" id="compteur-temps-restant" data-temps-restant="{{ temps_restant|default:0 }}">
                                    <i class="fas fa-hourglass-half me-1"></i>{{ temps_restant_str|default:"00:00:00" }}
                                </span>
                                {% endif %}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                                <li><a class="dropdown-item" href="{% url 'profile' %}"><i class="fas fa-user me-2"></i>Mon profil</a></li>
                                <li><a class="dropdown-item" href="{% url 'notifications:status' %}"><i class="fas fa-bell me-2"></i>Notifications</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{% url 'logout' %}"><i class="fas fa-sign-out-alt me-2"></i>D√©connexion</a></li>
                            </ul>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>
    
    <!-- Messages -->
    {% if messages %}
    <div class="container mt-3">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- Content -->
    <main class="flex-grow-1">
        {% block content %}{% endblock %}
    </main>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5>IPS-CO SARL</h5>
                    <p class="text-muted">Plateforme de gestion et de suivi douanier</p>
                </div>
                <div class="col-md-4">
                    <h5>Liens rapides</h5>
                    <ul class="list-unstyled">
                        <li><a href="{% url 'home' %}" class="text-white-50">Accueil</a></li>
                        {% if user.is_authenticated %}
                        <li><a href="{% url 'profile' %}" class="text-white-50">Mon profil</a></li>
                        {% endif %}
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5>Contact</h5>
                    <address class="text-white-50">
                        <i class="fas fa-map-marker-alt me-2"></i> Lubumbashi/Kibati, RDC<br>
                        <i class="fas fa-phone me-2"></i> +243 995 178 105<br>
                        <i class="fas fa-envelope me-2"></i> totoasofes22@gmail.com
                    </address>
                </div>
            </div>
            <hr class="bg-white-50">
            <div class="text-center">
                <p class="mb-0 text-white-50">&copy; {% now "Y" %} IPS-CO SARL. Tous droits r√©serv√©s.</p>
            </div>
        </div>
    </footer>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- Custom JS -->
    <script src="{% static 'js/countdown.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            updateCountdown(); // Initial call to display immediately
            setInterval(updateCountdown, 1000); // Update every second
        });
    </script>
    {% if user.is_authenticated %}
    <!-- Ic√¥ne flottante de chat -->
    <button id="open-chat-btn" style="z-index:99999 !important; pointer-events:auto !important; background:rgba(255,200,0,0.7) !important; border:2px solid #e74c3c !important; position:fixed !important; bottom:30px; right:30px; width:60px; height:60px; border-radius:50%; display:flex; align-items:center; justify-content:center;"><i class="fas fa-comments"></i><span id="chat-unread-badge" style="display:none; position:absolute; top:8px; right:8px; width:16px; height:16px; background:#e74c3c; color:white; border-radius:50%; font-size:11px; line-height:16px; text-align:center; font-weight:bold; box-shadow:0 0 6px #fff; animation:pulse 1s infinite alternate;"></span></button>

    <!-- Toast notification -->
    <div id="chat-toast" style="display:none; position:fixed; bottom:110px; right:40px; min-width:220px; max-width:350px; background:#fff; border-radius:8px; box-shadow:0 4px 16px rgba(0,0,0,0.18); z-index:1200; border-left:5px solid #e74c3c; padding:12px 16px;">
        <div style="font-weight:bold; color:#e74c3c;"><i class="fas fa-comment-dots me-1"></i><span id="toast-sender"></span></div>
        <div id="toast-content" style="color:#333; font-size:15px;"></div>
        <div id="toast-timestamp" class="text-muted small mt-1"></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
    try {
        const openBtn = document.getElementById('open-chat-btn');
        const closeBtn = document.getElementById('close-chat-btn');
        const chatWindow = document.getElementById('chat-window');
        const userSelect = document.getElementById('chat-user-select');
        const messagesDiv = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const unreadBadge = document.getElementById('chat-unread-badge');
        const toast = document.getElementById('chat-toast');
        const toastSender = document.getElementById('toast-sender');
        const toastContent = document.getElementById('toast-content');
        const toastTimestamp = document.getElementById('toast-timestamp');
        let currentUserId = null;
        let lastToastMsg = '';

        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function renderMessage(msg, isLastSentByMe) {
            // Style pour les messages syst√®me
            if (msg.is_system_message) {
                return `<div class="d-flex flex-column align-items-center mb-2">
                    <div class="small text-muted">${msg.timestamp}</div>
                    <div class="p-2 rounded bg-light border border-info" style="max-width:90%; word-break:break-word; text-align: center;">
                        <i class="fas fa-info-circle text-info me-1"></i> ${msg.content}
                    </div>
                </div>`;
            }
            
            // Style pour les messages normaux
            const align = msg.sent_by_me ? 'right' : 'left';
            const bg = msg.sent_by_me ? 'bg-primary text-white' : 'bg-light';
            let status = '';
            
            if (msg.sent_by_me && isLastSentByMe) {
                status = `<span class='ms-2 small ${msg.is_read ? 'text-success' : 'text-muted'}'></span>`;
            }
            
            return `<div class="d-flex flex-column align-items-${align} mb-2">
                <div class="small text-muted">${msg.sender} <span class="ms-2">${msg.timestamp}</span>${status}</div>
                <div class="p-2 rounded ${bg}" style="max-width:80%; word-break:break-word;">${msg.content}</div>
            </div>`;
        }

        function loadUsers() {
            fetch('{% url "get_users" %}')
                .then(r => r.json())
                .then(data => {
                    userSelect.innerHTML = '<option value="">-- S√©lectionner un utilisateur --</option>' +
                        data.users.map(u => `<option value="${u.id}">${u.name} (${u.role})${u.unread_count > 0 ? ' üî¥' : ''}</option>`).join('');
                });
        }

        function loadMessages() {
            if (!currentUserId) { messagesDiv.innerHTML = '<div class="text-center text-muted mt-3">S√©lectionnez un utilisateur.</div>'; return; }
            fetch('{% url "get_messages" %}?correspondent_id=' + currentUserId)
                .then(r => r.json())
                .then(data => {
                    let lastSentByMeIdx = -1;
                    data.messages.forEach((m, i) => { if (m.sent_by_me) lastSentByMeIdx = i; });
                    messagesDiv.innerHTML = data.messages.map((msg, i) => renderMessage(msg, i === lastSentByMeIdx)).join('');
                    scrollToBottom();
                });
        }

        function notifySystem(title, body) {
            if (window.Notification && Notification.permission === 'granted') {
                new Notification(title, { body: body });
            } else if (window.Notification && Notification.permission !== 'denied') {
                Notification.requestPermission().then(function(permission) {
                    if (permission === 'granted') {
                        new Notification(title, { body: body });
                    }
                });
            }
        }

        function checkUnread() {
            fetch('{% url "get_unread_messages_status" %}')
                .then(r => r.json())
                .then(data => {
                    if (data.unread_count > 0) {
                        unreadBadge.style.display = 'block';
                        unreadBadge.textContent = data.unread_count > 9 ? '9+' : data.unread_count;
                        if (chatWindow.style.display !== 'block' && data.last_unread) {
                            const msgKey = data.last_unread.sender + data.last_unread.content + data.last_unread.timestamp;
                            if (msgKey !== lastToastMsg) {
                                toastSender.textContent = data.last_unread.sender;
                                toastContent.textContent = data.last_unread.content;
                                toastTimestamp.textContent = data.last_unread.timestamp;
                                toast.style.display = 'block';
                                setTimeout(() => { toast.style.display = 'none'; }, 5000);
                                lastToastMsg = msgKey;
                                // Notification syst√®me navigateur
                                notifySystem('Nouveau message de ' + data.last_unread.sender, data.last_unread.content);
                            }
                        }
                    } else {
                        unreadBadge.style.display = 'none';
                        toast.style.display = 'none';
                        lastToastMsg = '';
                    }
                });
        }

        if (openBtn && chatWindow) {
            openBtn.onclick = function() {
                console.log('Clic d√©tect√© sur le bouton chat (FORCE CSS) !');
                chatWindow.style.display = 'block';
                if (typeof loadUsers === 'function') loadUsers();
                if (typeof loadMessages === 'function' && currentUserId) loadMessages();
                if (typeof unreadBadge !== 'undefined') unreadBadge.style.display = 'none';
                if (typeof toast !== 'undefined') toast.style.display = 'none';
            };
        }
        if (closeBtn && chatWindow) {
            closeBtn.onclick = function() { chatWindow.style.display = 'none'; };
        }
        if (userSelect) {
            userSelect.onchange = function() {
                currentUserId = this.value;
                loadMessages();
            };
        }
        if (chatForm && chatInput) {
            chatForm.onsubmit = function(e) {
                e.preventDefault();
                if (!currentUserId || !chatInput.value.trim()) return;
                const formData = new FormData();
                formData.append('recipient_id', currentUserId);
                formData.append('content', chatInput.value);
                fetch('{% url "send_message" %}', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                    body: formData
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        chatInput.value = '';
                        loadMessages();
                    }
                });
            };
        }
        // V√©rifier les messages non lus toutes les 30 secondes au lieu de 2 secondes
        let unreadCheckInterval = setInterval(checkUnread, 30000);
        
        // V√©rifier les messages de la discussion ouverte plus fr√©quemment (toutes les 5 secondes)
        let messageCheckInterval = setInterval(function() {
            if (chatWindow && chatWindow.style.display === 'block' && currentUserId) {
                loadMessages();
            }
        }, 5000);
        
        // V√©rifier imm√©diatement au chargement de la page
        checkUnread();
        
        // Nettoyer les intervalles lorsque la page est d√©charg√©e
        window.addEventListener('beforeunload', function() {
            clearInterval(unreadCheckInterval);
            clearInterval(messageCheckInterval);
        });
    } catch(e) {
        alert('Erreur JS chat : ' + e.message);
    }
    });
    </script>
    {% endif %}
    <!-- BOUTON CHAT UNIQUE ET FONCTIONNEL -->
    
    <div id="chat-window" class="fade-in" style="display:none; position:fixed; bottom:100px; right:30px; width:350px; max-width:95vw; background:white; border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,0.18); z-index:99999;">
        <div style="background:linear-gradient(135deg, #f39c12, #e74c3c); color:white; border-radius:12px 12px 0 0; padding:12px 16px; display:flex; align-items:center; justify-content:space-between;">
            <span><i class="fas fa-comments me-2"></i>Messagerie</span>
            <button id="close-chat-btn" class="btn btn-sm btn-light" style="border-radius:50%;"><i class="fas fa-times"></i></button>
        </div>
        <div style="display:flex; border-bottom:1px solid #eee;">
            <select id="chat-user-select" class="form-select form-select-sm m-2" style="width:calc(100% - 16px);"></select>
        </div>
        <div id="chat-messages" style="height:260px; overflow-y:auto; padding:10px; background:#fafbfc;"></div>
        <form id="chat-form" style="display:flex; border-top:1px solid #eee;">
            <input id="chat-input" type="text" class="form-control" placeholder="Votre message..." autocomplete="off" style="border:none; border-radius:0;">
            <button class="btn btn-primary" type="submit"><i class="fas fa-paper-plane"></i></button>
        </form>
    </div>
    {% block extra_js %}
    <script>
    // Enregistrement du service worker et abonnement push
    if ('serviceWorker' in navigator && 'PushManager' in window) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('/static/js/service-worker.js')
                .then(function(registration) {
                    // Demande la permission de notification
                    return Notification.requestPermission().then(function(permission) {
                        if (permission === 'granted') {
                            // S'abonne au push
                            const vapidPublicKey = '{{ VAPID_PUBLIC_KEY|default:"" }}';
                            if (!vapidPublicKey) return;
                            const convertedVapidKey = urlBase64ToUint8Array(vapidPublicKey);
                            registration.pushManager.subscribe({
                                userVisibleOnly: true,
                                applicationServerKey: convertedVapidKey
                            }).then(function(subscription) {
                                // Envoie l'abonnement au backend (√† adapter)
                                fetch('/notifications/save_subscription/', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': getCookie('csrftoken')
                                    },
                                    body: JSON.stringify(subscription)
                                });
                            });
                        }
                    });
                });
        });
    }
    // Conversion cl√© VAPID
    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }
    // R√©cup√®re le cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    </script>
    {% endblock %}
</body>
</html> 
