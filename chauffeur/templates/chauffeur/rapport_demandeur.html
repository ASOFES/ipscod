{% extends 'base.html' %}
{% block title %}Rapport Demandeur{% endblock %}
{% block content %}
<div class="container mt-4">
    <h2 class="mb-4"><i class="fas fa-user me-2"></i>Rapport Demandeur</h2>
    <form method="get" class="row g-3 mb-4">
        {% if demandeurs %}
        <div class="col-md-3">
            <label for="demandeur_id" class="form-label">Demandeur</label>
            <select name="demandeur_id" id="demandeur_id" class="form-select">
                <option value="">-- Tous les demandeurs --</option>
                {% for d in demandeurs %}
                <option value="{{ d.id }}" {% if demandeur_id and demandeur_id|add:'0' == d.id|stringformat:'s' %}selected{% endif %}>{{ d.get_full_name }} ({{ d.username }})</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
        <div class="col-md-3">
            <label for="date_debut" class="form-label">Date début</label>
            <input type="date" name="date_debut" id="date_debut" class="form-control" value="{{ date_debut }}">
        </div>
        <div class="col-md-3">
            <label for="date_fin" class="form-label">Date fin</label>
            <input type="date" name="date_fin" id="date_fin" class="form-control" value="{{ date_fin }}">
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button type="submit" class="btn btn-primary me-2"><i class="fas fa-search me-2"></i>Filtrer</button>
            <a href="?" class="btn btn-outline-secondary"><i class="fas fa-redo me-2"></i>Réinitialiser</a>
        </div>
        <div class="col-md-3 d-flex align-items-end justify-content-end">
            <a href="{% url 'chauffeur:rapport_demandeur_pdf' %}?date_debut={{ date_debut }}&date_fin={{ date_fin }}" class="btn btn-danger me-2"><i class="fas fa-file-pdf me-1"></i>Exporter PDF</a>
            <a href="{% url 'chauffeur:rapport_demandeur_excel' %}?date_debut={{ date_debut }}&date_fin={{ date_fin }}" class="btn btn-success"><i class="fas fa-file-excel me-1"></i>Exporter Excel</a>
        </div>
    </form>
    <div class="row mb-2">
        <div class="col-md-6">
            <h5>Département : <span class="fw-bold">{{ departement }}</span></h5>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Missions totales</h5>
                    <h3>{{ total_missions }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Terminées</h5>
                    <h3 class="text-success">{{ missions_terminees }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">En cours</h5>
                    <h3 class="text-warning">{{ missions_en_cours }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Validées</h5>
                    <h3 class="text-info">{{ missions_validees }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Km parcourus</h5>
                    <h3>{{ total_km }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Coût estimé</h5>
                    <h3>{{ cout_total_estime|floatformat:2 }} $</h3>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <h4>Destinations les plus fréquentes</h4>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Destination</th>
                            <th>Nombre de missions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dest in destinations_frequentes %}
                        <tr>
                            <td>{{ dest.destination }}</td>
                            <td>{{ dest.count }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="2" class="text-center">Aucune donnée disponible.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="col-md-6">
            <h4>Chauffeurs les plus utilisés</h4>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Chauffeur</th>
                            <th>Nombre de missions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for chauffeur in chauffeurs_frequents %}
                        <tr>
                            <td>{{ chauffeur.chauffeur__first_name }} {{ chauffeur.chauffeur__last_name }}</td>
                            <td>{{ chauffeur.count }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="2" class="text-center">Aucune donnée disponible.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <h4 class="mt-4">Statistiques par mois</h4>
    <div class="table-responsive mb-4">
        <table class="table table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th>Mois</th>
                    <th>Missions</th>
                    <th>Kilomètres</th>
                </tr>
            </thead>
            <tbody>
                {% for stat in stats_mois %}
                <tr>
                    <td>{{ stat.mois|date:'F Y' }}</td>
                    <td>{{ stat.missions }}</td>
                    <td>{{ stat.km }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="3" class="text-center">Aucune donnée disponible.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="row mb-4">
        <div class="col-md-6">
            <canvas id="kmChart"></canvas>
        </div>
        <div class="col-md-6">
            <canvas id="missionsChart"></canvas>
        </div>
    </div>
    
    <!-- Liste des missions avec pagination -->
    <h4 class="mt-4">Liste des missions</h4>
    <div class="table-responsive mb-4">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Date</th>
                    <th>Point d'embarquement</th>
                    <th>Destination</th>
                    <th>Statut</th>
                    <th>Chauffeur</th>
                    <th>Véhicule</th>
                    <th>Distance (km)</th>
                </tr>
            </thead>
            <tbody>
                {% for mission in missions %}
                <tr>
                    <td>{{ mission.id }}</td>
                    <td>{{ mission.date_validation|date:'d/m/Y H:i' }}</td>
                    <td>{{ mission.point_embarquement }}</td>
                    <td>{{ mission.destination }}</td>
                    <td>
                        <span class="badge {% if mission.statut == 'terminee' %}bg-success{% elif mission.statut == 'en_cours' %}bg-warning{% elif mission.statut == 'validee' %}bg-info{% elif mission.statut == 'refusee' %}bg-danger{% else %}bg-secondary{% endif %}">
                            {{ mission.get_statut_display }}
                        </span>
                    </td>
                    <td>{% if mission.chauffeur %}{{ mission.chauffeur.get_full_name }}{% else %}-{% endif %}</td>
                    <td>{% if mission.vehicule %}{{ mission.vehicule.immatriculation }}{% else %}-{% endif %}</td>
                    <td>{{ mission.distance_parcourue|default:'-' }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="8" class="text-center">Aucune mission trouvée pour cette période.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    {% if missions.has_other_pages %}
    <nav aria-label="Pagination des missions">
        <ul class="pagination justify-content-center">
            {% if missions.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1{% if date_debut %}&date_debut={{ date_debut }}{% endif %}{% if date_fin %}&date_fin={{ date_fin }}{% endif %}{% if demandeur_id %}&demandeur_id={{ demandeur_id }}{% endif %}" aria-label="Première">
                        <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ missions.previous_page_number }}{% if date_debut %}&date_debut={{ date_debut }}{% endif %}{% if date_fin %}&date_fin={{ date_fin }}{% endif %}{% if demandeur_id %}&demandeur_id={{ demandeur_id }}{% endif %}" aria-label="Précédente">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            {% endif %}
            
            {% for i in missions.paginator.page_range %}
                {% if missions.number == i %}
                    <li class="page-item active" aria-current="page">
                        <span class="page-link">{{ i }}</span>
                    </li>
                {% elif i > missions.number|add:'-3' and i < missions.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ i }}{% if date_debut %}&date_debut={{ date_debut }}{% endif %}{% if date_fin %}&date_fin={{ date_fin }}{% endif %}{% if demandeur_id %}&demandeur_id={{ demandeur_id }}{% endif %}">{{ i }}</a>
                    </li>
                {% endif %}
            {% endfor %}
            
            {% if missions.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ missions.next_page_number }}{% if date_debut %}&date_debut={{ date_debut }}{% endif %}{% if date_fin %}&date_fin={{ date_fin }}{% endif %}{% if demandeur_id %}&demandeur_id={{ demandeur_id }}{% endif %}" aria-label="Suivante">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ missions.paginator.num_pages }}{% if date_debut %}&date_debut={{ date_debut }}{% endif %}{% if date_fin %}&date_fin={{ date_fin }}{% endif %}{% if demandeur_id %}&demandeur_id={{ demandeur_id }}{% endif %}" aria-label="Dernière">
                        <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
    
    <h4 class="mt-4">Commentaires / Appréciations</h4>
    <div class="mb-4">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
        <form method="post" class="mb-3">
            {% csrf_token %}
            <textarea class="form-control mb-2" name="commentaire" rows="3" placeholder="Zone réservée à l'administration ou au demandeur pour les remarques..."></textarea>
            <button type="submit" class="btn btn-primary"><i class="fas fa-comment-dots me-1"></i>Enregistrer le commentaire</button>
        </form>
        <div>
            <h6>Commentaires enregistrés :</h6>
            {% for c in commentaires %}
                <div class="border rounded p-2 mb-2">
                    <div class="small text-muted">Par {% if c.auteur %}{{ c.auteur.username }}{% else %}Anonyme{% endif %} le {{ c.date_commentaire|date:'d/m/Y H:i' }}</div>
                    <div>{{ c.texte|linebreaks }}</div>
                </div>
            {% empty %}
                <div class="text-muted">Aucun commentaire pour cette période.</div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Préparer les données pour les graphiques
    const labels = [{% for stat in stats_mois %}'{{ stat.mois|date:'M Y' }}',{% endfor %}];
    const kmData = [{% for stat in stats_mois %}{{ stat.km }},{% endfor %}];
    const missionsData = [{% for stat in stats_mois %}{{ stat.missions }},{% endfor %}];
    
    // Graphique kilométrage
    new Chart(document.getElementById('kmChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Kilomètres parcourus',
                data: kmData,
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } }
        }
    });
    
    // Graphique missions
    new Chart(document.getElementById('missionsChart'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Missions demandées',
                data: missionsData,
                backgroundColor: 'rgba(255, 99, 132, 0.5)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } }
        }
    });
</script>
{% endblock %} 